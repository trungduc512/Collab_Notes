worker_processes auto;

events { worker_connections 1024; }

http {
    include mime.types;
    default_type application/json;

    lua_shared_dict jwt_cache 10m;
    lua_package_path "/usr/local/openresty/lualib/?.lua;;";

    init_by_lua_block {
        jwt = require("resty.jwt")
        cjson = require("cjson")
    }

    upstream auth_service {
        server auth-service:5001;
    }

    upstream doc_service {
        server document-service:5002;
    }

    upstream ws_service {
        server websocket-service:5003;
    }

    server {
        listen 80;

        #######################################################################
        # PUBLIC: LOGIN  (NO JWT)
        #######################################################################
        location /auth/login {

            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "http://localhost:5173";
                add_header Access-Control-Allow-Credentials true;
                add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-User-Id, X-User-Name";
                add_header Access-Control-Allow-Methods "POST, OPTIONS";
                return 204;
            }

            add_header Access-Control-Allow-Origin "http://localhost:5173" always;
            add_header Access-Control-Allow-Credentials true always;

            proxy_pass http://auth_service/auth/login;
        }

        #######################################################################
        # PUBLIC: REGISTER (NO JWT)
        #######################################################################
        location /auth/register {

            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "http://localhost:5173";
                add_header Access-Control-Allow-Credentials true;
                add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-User-Id, X-User-Name";
                add_header Access-Control-Allow-Methods "POST, OPTIONS";
                return 204;
            }

            add_header Access-Control-Allow-Origin "http://localhost:5173" always;
            add_header Access-Control-Allow-Credentials true always;

            proxy_pass http://auth_service/auth/register;
        }

        #######################################################################
        # PRIVATE: /auth/me (JWT)
        #######################################################################
        location /auth/me {

            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "http://localhost:5173";
                add_header Access-Control-Allow-Credentials true;
                add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-User-Id, X-User-Name";
                add_header Access-Control-Allow-Methods "GET, OPTIONS";
                return 204;
            }

            add_header Access-Control-Allow-Origin "http://localhost:5173" always;
            add_header Access-Control-Allow-Credentials true always;

            # JWT VERIFY
            set_by_lua_block $jwt_user_id {
                local auth = ngx.req.get_headers()["Authorization"]
                if not auth then return "" end

                local token = auth:gsub("Bearer ", "")
                local jwt_obj = jwt:verify("hao123", token)

                if jwt_obj.verified then
                    return jwt_obj.payload.id
                else
                    ngx.status = 401
                    ngx.say(cjson.encode({ message = "Invalid JWT" }))
                    ngx.exit(401)
                end
            }

            proxy_set_header X-User-Id $jwt_user_id;
            proxy_set_header Authorization $http_authorization;
            proxy_set_header authorization $http_authorization;   # lowercase header fix for WS


            proxy_pass http://auth_service/auth/me;
        }

        #######################################################################
        # PRIVATE: DOCUMENTS
        #######################################################################
        location /documents {

            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "http://localhost:5173";
                add_header Access-Control-Allow-Credentials true;
                add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-User-Id, X-User-Name";
                add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS";
                return 204;
            }

            add_header Access-Control-Allow-Origin "http://localhost:5173" always;
            add_header Access-Control-Allow-Credentials true always;

            # JWT VERIFY
            set_by_lua_block $jwt_user_id {
                local auth = ngx.req.get_headers()["Authorization"]
                if not auth then return "" end
                local token = auth:gsub("Bearer ", "")
                local jwt_obj = jwt:verify("hao123", token)
                if jwt_obj.verified then
                    return jwt_obj.payload.id
                else
                    ngx.status = 401
                    ngx.say(cjson.encode({ message = "Invalid JWT" }))
                    ngx.exit(401)
                end
            }

            proxy_set_header X-User-Id $jwt_user_id;
            proxy_set_header Authorization $http_authorization;
            proxy_set_header authorization $http_authorization;   # lowercase header fix for WS


            proxy_pass http://doc_service;
        }

        #######################################################################
        # PRIVATE: WEBSOCKET
        #######################################################################
        location /ws/socket.io/ {

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";

            # CORS
            add_header Access-Control-Allow-Origin "http://localhost:5173" always;
            add_header Access-Control-Allow-Credentials true always;

            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "http://localhost:5173";
                add_header Access-Control-Allow-Credentials true;
                add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-User-Id";
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
                return 204;
            }

            # JWT verify
            set_by_lua_block $jwt_user_id {
                local auth = ngx.req.get_headers()["Authorization"]
                if not auth then return "" end
                local token = auth:gsub("Bearer ", "")
                local jwt_obj = jwt:verify("hao123", token)
                if jwt_obj.verified then
                    return jwt_obj.payload.id
                else
                    return ""
                end
            }

            proxy_set_header X-User-Id $jwt_user_id;

            proxy_pass http://ws_service;
        }

        #######################################################################
        # GLOBAL OPTIONS HANDLER  â€”  ALWAYS WORKS
        #######################################################################
        location / {
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "http://localhost:5173";
                add_header Access-Control-Allow-Credentials true;
                add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-User-Id, X-User-Name";
                add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS";
                return 204;
            }
            return 404;
        }
    }
}
