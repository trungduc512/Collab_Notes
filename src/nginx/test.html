<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Cluster Test</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1rem;
      }
      .container {
        display: flex;
        gap: 10px;
        margin-bottom: 1rem;
      }
      input {
        padding: 8px;
        flex-grow: 1;
      }
      button {
        padding: 8px 16px;
        cursor: pointer;
      }
      #status {
        font-weight: bold;
        margin-bottom: 1rem;
      }
      .connected {
        color: green;
      }
      .disconnected {
        color: red;
      }
      textarea {
        width: 100%;
        height: 150px;
        margin-bottom: 1rem;
        padding: 10px;
      }
      pre {
        background: #f4f4f4;
        padding: 10px;
        height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
      }
    </style>
  </head>
  <body>
    <h1>üîç Test WebSocket Sharding</h1>
    <p>
      Nh·∫≠p t√™n t√†i li·ªáu ƒë·ªÉ ki·ªÉm tra. Nginx s·∫Ω ƒëi·ªÅu h∆∞·ªõng c√°c t√†i li·ªáu kh√°c nhau
      v√†o c√°c server kh√°c nhau (d·ª±a tr√™n Hash).
    </p>

    <div class="container">
      <input
        type="text"
        id="docName"
        placeholder="Nh·∫≠p t√™n t√†i li·ªáu (vd: doc-1, doc-2)"
        value="doc-1"
      />
      <button onclick="connect()" id="btnConnect">K·∫øt n·ªëi</button>
      <button onclick="disconnect()" disabled id="btnDisconnect">Ng·∫Øt</button>
    </div>

    <div id="status" class="disconnected">Tr·∫°ng th√°i: Ch∆∞a k·∫øt n·ªëi</div>

    <h3>üìù So·∫°n th·∫£o th·ª≠ (Real-time Sync)</h3>
    <textarea
      id="editor"
      placeholder="G√µ v√†o ƒë√¢y ƒë·ªÉ test ƒë·ªìng b·ªô..."
      disabled
    ></textarea>

    <h3>log h·ªá th·ªëng:</h3>
    <pre id="logs"></pre>

    <script type="module">
      import * as Y from "https://esm.sh/yjs@13";
      import { WebsocketProvider } from "https://esm.sh/y-websocket@1";

      let provider = null;
      let doc = null;
      let yText = null;

      const log = (msg) => {
        const logs = document.getElementById("logs");
        logs.innerText =
          `[${new Date().toLocaleTimeString()}] ${msg}\n` + logs.innerText;
      };

      window.connect = () => {
        const docName = document.getElementById("docName").value.trim();
        if (!docName) return alert("Vui l√≤ng nh·∫≠p t√™n t√†i li·ªáu!");

        if (provider) provider.destroy();

        // Kh·ªüi t·∫°o Yjs Doc
        doc = new Y.Doc();

        // K·∫øt n·ªëi ƒë·∫øn Nginx Gateway (c·ªïng 80)
        // ws://localhost:80/docName
        const gatewayUrl = "ws://localhost:80";

        log(`üîÑ ƒêang k·∫øt n·ªëi t·ªõi ${gatewayUrl}/${docName}...`);

        provider = new WebsocketProvider(gatewayUrl, docName, doc);

        // X·ª≠ l√Ω s·ª± ki·ªán tr·∫°ng th√°i
        provider.on("status", (event) => {
          const statusEl = document.getElementById("status");
          statusEl.innerText = `Tr·∫°ng th√°i: ${event.status}`;
          statusEl.className = event.status;

          log(`üì° Connection Status: ${event.status}`);

          if (event.status === "connected") {
            document.getElementById("editor").disabled = false;
            document.getElementById("btnConnect").disabled = true;
            document.getElementById("btnDisconnect").disabled = false;
          } else {
            document.getElementById("editor").disabled = true;
          }
        });

        // Binding Textarea v·ªõi Yjs (Sync logic ƒë∆°n gi·∫£n)
        yText = doc.getText("content");
        const editor = document.getElementById("editor");

        // Khi d·ªØ li·ªáu t·ª´ Server v·ªÅ -> C·∫≠p nh·∫≠t Textarea
        yText.observe(() => {
          if (editor.value !== yText.toString()) {
            editor.value = yText.toString();
          }
        });

        // Khi ng∆∞·ªùi d√πng g√µ -> G·ª≠i l√™n Server
        editor.oninput = () => {
          if (editor.value !== yText.toString()) {
            doc.transact(() => {
              yText.delete(0, yText.length);
              yText.insert(0, editor.value);
            });
          }
        };
      };

      window.disconnect = () => {
        if (provider) {
          provider.destroy();
          provider = null;
          document.getElementById("status").innerText = "Tr·∫°ng th√°i: ƒê√£ ng·∫Øt";
          document.getElementById("status").className = "disconnected";
          document.getElementById("editor").disabled = true;
          document.getElementById("btnConnect").disabled = false;
          document.getElementById("btnDisconnect").disabled = true;
          log("‚ùå ƒê√£ ng·∫Øt k·∫øt n·ªëi.");
        }
      };
    </script>
  </body>
</html>
